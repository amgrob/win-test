version: 2.1

defaults: &defaults
  resource_class: medium

win: &win
  executor:
      name: win/default

nix: &nix
  docker:
      - image: circleci/node:15.0
  

orbs:
  win: circleci/windows@2.2.0

jobs:
  build-cli:
    <<: *nix
    steps:
      checkout
      - run:
          command: git clone https://github.com/aws-amplify/amplify-cli
      - run: 
          command: pwd
      - run:
          command: ls -la
      # - run: 
      #     command: cd amplify-cli && yarn run production-build
      # - save_cache:
      #     key: amplify-cli-yarn-deps-{{ .Branch }}-{{ checksum "yarn.lock" }}
      #     paths:
      #       - ~/.cache
      # - save_cache:
      #     key: amplify-cli-ssh-deps-{{ .Branch }}
      #     paths:
      #       - ~/.ssh
      # - persist_to_workspace:
      #     root: .
      #     paths: .
  build-win:
    <<: *win
    steps:
      - run:
         command: node --version
         shell: cmd.exe
      - run:
         command: yarn --version
         shell: cmd.exe
  build-nix:
    <<: *defaults
    <<: *nix
    steps:
      - checkout
      - run: yarn --version
      - run: npm i
      - persist_to_workspace:
          root: .
          paths: .
    #   - run: yarn cache clean --force
    #   - run: yarn run production-build
    #   - save_cache:
    #       key: amplify-codegen-yarn-deps-{{ .Branch }}-{{ checksum "yarn.lock" }}
    #       paths:
    #         - ~/.cache
    #   - save_cache:
    #       key: amplify-codegen-ssh-deps-{{ .Branch }}
    #       paths:
    #         - ~/.ssh
    #   - persist_to_workspace:
    #       root: .
    #       paths: .
#   build-macos:
#     macos:
#       xcode: 11.3.0
#     steps:
#       - checkout
#       - run: echo 'Do something'
  test-nix:
    <<: *defaults
    docker:
      - image: circleci/node:15.0
    steps:
      - attach_workspace:
          at: ./
      - run:
          name: Lint
          command: yarn lint
  test-win:
    <<: *win
    steps:
      - attach_workspace:
          at: ./
      - run:
          name: Lint
          command: yarn lint
workflows:
  build-and-deploy:
    jobs:
    - build-cli
    # - build-win
    # # - build-macos
    # - build-nix 
    # - test-nix:
    #     requires:
    #       - build-nix
    